<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="css/style.css" />
<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />

<style>
	#controls {
		width: 100%;
		position: relative;
		overflow: hidden;
			margin: 4px;
		font-size: 50%;
		float: right;
	}
	.slider {
		width: 200px;
		margin: 2px;
	}
	input {
		width: 40px;
		color: black;
		border: 1px;
		text-align: center;
		margin-left: 10px;
		margin-right: 10px;
	}
	.left {
		float: left;
		position: relative;
	}
	.right { 
		height: 100%;
		position: relative;
		overflow: hidden;
	}
</style>

<body> 
	<div class='container' id='main'>
		<video id='video' autoplay='true' style='display:none'></video>
		<canvas id='c'></canvas>
	</div>
	<div id='controls' style='display:none'>
		<span style='float:right'>
			<button id='snapshot-btn' onclick='snapshot()'>Snapshot</button>
		</span>
		
		<div class='slider-panel'>
			<div class='left slider' id='slider1'></div>
			<div class='right'>
				<label for='amount1' />
				<input type='text' id='amount1' />
				<string>T</string>
			</div>
		</div>
		<div class='slider-panel'>
			<div class='left slider' id='slider2'></div>
			<div class='right'>
				<label for='amount2' />
				<input type='text' id='amount2' />
				<string>R</string>
			</div>
		</div>
		<div class='slider-panel'>
			<div class='left slider' id='slider3'></div>
			<div class='right'>
				<label for='amount3' />
				<input type='text' id='amount3' />
				<string>G</string>
			</div>
		</div>
		<div class='slider-panel'>
			<div class='left slider' id='slider4'></div>
			<div class='right'>
				<label for='amount4' />
				<input type='text' id='amount4' />
				<string>B</string>
			</div>
		</div>
		<div id='snapshot-section'>
			<img id='snapshot-img'></img>
		</div>
	</div>

	<script src='js/webgl-utils.js'></script>
	<script src='js/video-utils.js'></script>
	<script src='http://code.jquery.com/jquery-latest.min.js'></script>
	<script src='http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js'></script>
	
	<script id='vshader' type='text/plain'>
		attribute vec2 position;
		void main(void) {
			gl_Position = vec4(position, 0, 1);
		}
	</script>

	<script id='fshader' type='text/plain'>
		precision mediump float;
		uniform sampler2D sampler0;
		uniform float width, height;
		uniform float K1, K2, K3, K4;
		void main() {
			vec2 st = vec2(gl_FragCoord.s/width, 1. - gl_FragCoord.t/height);
			float lum = length(texture2D(sampler0, st).rgb);
			gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
			if (lum < K1) {
				if (mod(gl_FragCoord.x + gl_FragCoord.y, 10.0) == 0.0)
					gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
			if (lum < K2) {
				if (mod(gl_FragCoord.x - gl_FragCoord.y, 10.0) == 0.0)
					gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
			if (lum < K3) {
				if (mod(gl_FragCoord.x + gl_FragCoord.y - .0, 10.0) == 0.0)
					gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
			if (lum < K4) {
				if (mod(gl_FragCoord.x - gl_FragCoord.y - .0, 10.0) == 0.0) 
					gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
		}
	</script>
	
	<script>
		var videoScale = .75;
		var video, c, gl, shader;
		var k1Location, k2Location, k3Location, k4Location;

		document.addEventListener("DOMContentLoaded", function(event) {
			video = document.getElementById('video');
			c = document.getElementById('c');
			gl = c.getContext('experimental-webgl') || c.getContext('webgl');
			shader = new webglShader(gl);
			
			setupCamera(video, function(err, stream) { 
				if (err)
					console.log('VIDEO INITIALIZATION FAILED: ' + err.name);
				else {
					video.style.display = '';
					document.getElementById('controls').style.display = '';
					video.width = video.videoWidth *= videoScale;
					video.height = video.videoHeight *= videoScale;
					c.width = video.width;
					c.height = video.height;
					render();
				}
			});
		});

		function render() {
			// CREATE SHADER PROGRAM
			var vs = document.getElementById('vshader').textContent;
			var fs = document.getElementById('fshader').textContent;
			var program = shader.createProgram(vs, fs);
			gl.useProgram(program);

			// SET SHADER VARIABLES
			k1Location = gl.getUniformLocation(program, 'K1');
			k2Location = gl.getUniformLocation(program, 'K2');
			k3Location = gl.getUniformLocation(program, 'K3');
			k4Location = gl.getUniformLocation(program, 'K4');
			var widthLocation = gl.getUniformLocation(program, 'width');
			var heightLocation = gl.getUniformLocation(program, 'height');
			var samplerLocation = gl.getUniformLocation(program, 'sampler0');
			var positionLocation = gl.getAttribLocation(program, 'position');
			gl.uniform1f(k1Location, 1.);
			gl.uniform1f(k2Location, .75);
			gl.uniform1f(k3Location, .5);
			gl.uniform1f(k4Location, .25);
			gl.uniform1f(widthLocation, c.width);
			gl.uniform1f(heightLocation, c.height);
			gl.uniform1i(samplerLocation, 0);
			var vertexPosBuffer = webglScreenQuad(gl);  
			gl.enableVertexAttribArray(positionLocation);
			gl.vertexAttribPointer(positionLocation, vertexPosBuffer.itemSize, gl.FLOAT, false, 0, 0);
		
			// CREATE TEXTURE
			var texture = gl.createTexture();
			gl.activeTexture(gl.TEXTURE0);
			gl.bindTexture(gl.TEXTURE_2D, texture);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
			gl.bindTexture(gl.TEXTURE_2D, null);

			// RENDER LOOP
			gl.viewport(0, 0, c.width, c.height);
			window.requestAnimationFrame(function loop() {
				gl.activeTexture(gl.TEXTURE0);
				gl.bindTexture(gl.TEXTURE_2D, texture);
				gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, video);
				gl.drawArrays(gl.TRIANGLE_STRIP, 0, vertexPosBuffer.numItems);
				gl.bindTexture(gl.TEXTURE_2D, null);
				window.requestAnimationFrame(loop);
			});
		}
		
		function snapshot() {
			var dataURL = c.toDataURL();
			document.getElementById('snapshot-img').src = dataURL;
		}
		
		// -- Sliders --
		
		var slider_data = [ 
			{ slider:'#slider1', label:'#amount1', options:{min:0., max:1., step:.05, value:1., slide:function(event,ui) {
				$('#amount1').val(ui.value);
				gl.uniform1f(k1Location, ui.value);}}},
			{ slider:'#slider2', label:'#amount2', options:{min:0., max:1., step:.05, value:.75, slide:function(event,ui) {
				$('#amount2').val(ui.value);
				gl.uniform1f(k2Location, ui.value);}}},
			{ slider:'#slider3', label:'#amount3', options:{min:0., max:1., step:.05, value:.5, slide:function(event,ui) {
				$('#amount3').val(ui.value);
				gl.uniform1f(k3Location, ui.value);}}},
			{ slider:'#slider4', label:'#amount4', options:{min:0., max:1., step:.05, value:.25, slide:function(event,ui) {
				$('#amount4').val(ui.value);
				gl.uniform1f(k4Location, ui.value);}}}
		];
		
		for (var i = 0; i < slider_data.length; i++) {
			var data = slider_data[i];
			$(data.slider).slider(data.options);
			$(data.label).val(data.options.value);
		}
	</script>
