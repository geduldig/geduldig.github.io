<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<body>
	<div style="display:flex">
		<div style="justify-content:flex-start">
			<!-- VIDEO AND CANVAS -->
			<div>
				<video id='video' autoplay='true' style='display:none'></video>
				<canvas id='canvas'></canvas>
			</div>
		</div>
		<div style="justify-content:flex-start">
			<!-- VIDEO SOURCE CHOOSER -->
			<div class="select" style='margin-left:5px; padding:5px;'>
				<label for="videoSource">Video source: </label>
				<select id="videoSource"></select>
			</div>
			<br>
			<!-- SLIDER CONTROL -->
			<div style='display:inline-block'>
				<div class='controls' style='display:none'>
					<div style='margin-left:5px; padding:5px; font-size:.5em'>
						<div id='sliders' style='border-style:solid; border-width:1px; display:inline-block'/>
					</div>
					<br>
					<div style='margin-left:5px; padding:5px; font-size:2em'>
						<a id='save-snapshot' onclick='save()' href="#" download='photo_blur.png'>Save snapshot</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div>
		<!-- SNAPSHOT CONTROL -->
		<div class='controls' style='display:none'>
			<div style='margin-top:10px'>
				<img id='snapshot-img' download></img>
			</div>
		</div>
	</div>

	<script src='https://code.jquery.com/jquery-latest.min.js'></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src='js/JQueryUISlider.js'></script>
	<script src='js/webgl-utils.js'></script>
	<script src='js/video-utils.js'></script>

	<!-- SHADERS -->

	<script id='vshader' type='text/plain'>
		attribute vec2 position;
		void main(void) {
			gl_Position = vec4(position, 0, 1);
		}
	</script>

	<script id='fshader' type='text/plain'>
		precision mediump float;
		uniform sampler2D sampler0;
		uniform float width, height;
		uniform float K1, K2, K3;
		vec2 flip(vec2 st) {
			return vec2(st.x/width, 1. - st.y/height);
		}
		vec3 posterize(vec3 rgb) {
			float gamma = K1;
			float ncolors = K2;
			rgb = pow(rgb, vec3(gamma, gamma, gamma));
			rgb = rgb * ncolors;
			rgb = floor(rgb);
			rgb = rgb / ncolors;
			return pow(rgb, vec3(1./gamma));
		}
		vec3 colorLookup(int i, vec2 neighbor, float kernel) {
			vec2 patchSize = vec2(K3, K3);
			vec3 rgb = posterize((texture2D(sampler0, flip(gl_FragCoord.st + patchSize*neighbor)).rgb))*kernel;
			return rgb;
		}
		void main() {
			float kernel[9];
			kernel[0]=0.045, kernel[1]=0.122, kernel[2]=0.045,
			kernel[3]=0.122, kernel[4]=0.332, kernel[5]=0.122,
			kernel[6]=0.045, kernel[7]=0.122, kernel[8]=0.045;
			vec2 neighbor[9];
			neighbor[0]=vec2(-1,-1), neighbor[1]=vec2(0,-1), neighbor[2]=vec2(1,-1),
			neighbor[3]=vec2(-1,0), neighbor[4]=vec2(0,0), neighbor[5]=vec2(1,0),
			neighbor[6]=vec2(-1,1), neighbor[7]=vec2(0,1), neighbor[8]=vec2(1,1);
			vec3 colorSum = vec3(0,0,0);
			for (int i = 0; i < 9; i++)
				colorSum += colorLookup(i, neighbor[i], kernel[i]);
			float kernelWeight = .25;
			gl_FragColor = vec4(posterize(colorSum)/kernelWeight, 1.0);
			/*
			vec3 rgb = posterize(texture2D(sampler0, flip(gl_FragCoord.st)).rgb);
			gl_FragColor = vec4(rgb, 1.);
			*/
		}
	</script>

	<!-- MAIN PROGRAM -->

	<script>
		console.log("*** VIDEO_TEXTURE_BLUR: VERSION 2.10 ***");
		
		var k1, k2, k3;
		const videoSelect = document.querySelector('select#videoSource');
		const video = document.getElementById('video');
		const canvas = document.getElementById('canvas');
		const gl = canvas.getContext('webgl', {preserveDrawingBuffer:true});
		const shader = new webglShader(gl);

		document.addEventListener("DOMContentLoaded", function(event) {
			findCameras(videoSelect, video, function(err, stream) {
				if (err)
					alert('VIDEO INITIALIZATION FAILED: ' + err.name);
				else {
					showControls();
					resizeCanvas();
					render();
				}
			});
		});
		
		function showControls() {
			var controls = document.getElementsByClassName('controls');
			for (var i=0; i < controls.length; i++)
				controls[i].style.display = '';
		}

		function resizeCanvas() {
			if (video.videoWidth/video.videoHeight > screen.width/screen.height) {
				canvas.width = screen.width*.8;
				canvas.height = canvas.width*video.videoHeight/video.videoWidth;
			}
			else {
				canvas.height = screen.height*.8;
				canvas.width = canvas.height*video.videoWidth/video.videoHeight;
			}
		}

		function render() {
			// -- Create shader program --

			var vs = document.getElementById('vshader').textContent;
			var fs = document.getElementById('fshader').textContent;
			var program = shader.createProgram(vs, fs);
			gl.useProgram(program);

			// -- Set shader variables --

			k1 = gl.getUniformLocation(program, 'K1');
			k2 = gl.getUniformLocation(program, 'K2');
			k3 = gl.getUniformLocation(program, 'K3');
			var width = gl.getUniformLocation(program, 'width');
			var height = gl.getUniformLocation(program, 'height');
			var sampler = gl.getUniformLocation(program, 'sampler0');
			var position = gl.getAttribLocation(program, 'position');
			gl.uniform1f(k1, .6);
			gl.uniform1f(k2, 8.);
			gl.uniform1f(width, canvas.width);
			gl.uniform1f(height, canvas.height);
			gl.uniform1i(sampler, 0);
			var vertexPosBuffer = webglScreenQuad(gl);
			gl.enableVertexAttribArray(position);
			gl.vertexAttribPointer(position, vertexPosBuffer.itemSize, gl.FLOAT, false, 0, 0);

			// -- Create texture --

			var texture = gl.createTexture();
			gl.activeTexture(gl.TEXTURE0);
			gl.bindTexture(gl.TEXTURE_2D, texture);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
			gl.bindTexture(gl.TEXTURE_2D, null);

			// -- Render loop --

			gl.viewport(0, 0, canvas.width, canvas.height);
			window.requestAnimationFrame(function loop() {
				gl.activeTexture(gl.TEXTURE0);
				gl.bindTexture(gl.TEXTURE_2D, texture);
				gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, video);
				gl.drawArrays(gl.TRIANGLE_STRIP, 0, vertexPosBuffer.numItems);
				gl.bindTexture(gl.TEXTURE_2D, null);
				window.requestAnimationFrame(loop);
			});
		}

		function snapshot() {
			var dataURL = canvas.toDataURL();
			document.getElementById('snapshot-img').src = dataURL;
		}

		function save() {
			var link = document.getElementById('save-snapshot');
			var now = new Date();
			var stamp = now.getFullYear() + '-' + (now.getMonth() + 1) + '-' + now.getDate() + '-' +
			            now.getHours() + '-' + now.getMinutes() + '-' + now.getSeconds();
			link.download = 'photo_blur_' + stamp + '.png';
	    		link.href = document.getElementById('snapshot-img').src;
		}

		// -- Sliders --

		var slider_data = [
			{ label:'GAMMA', options:{min:0., max:1., step:.01, value:.6}, slide:function(value) {
				gl.uniform1f(k1, value);}},
			{ label:'NUMBER OF COLORS', options:{min:2., max:40., step:1., value:8.}, slide:function(value) {
				gl.uniform1f(k2, value);}},
			{ label:'PATCH SIZE', options:{min:1., max:40., step:1., value:1.}, slide:function(value) {
				gl.uniform1f(k3, value);}},
		];
		for (var i = 0; i < slider_data.length; i++)
			JQueryUISlider.CreateSlider('#sliders', slider_data[i]);
		JQueryUISlider.AddSliderStyle();
	</script>
