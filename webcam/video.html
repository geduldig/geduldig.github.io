<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">

<body>
	<div class="select">
		<label for="videoSource">Video source: </label>
		<select id="videoSource"></select>
	</div>
	
	<span>
		<video height=200 autoplay style="border:1px solid blue;"></video>
	</span>
	<span>
		<canvas height="200" style="border:1px solid red;"></canvas><br>
	</span>
	<div>
		<button onclick="snapshot()">Take Picture</button>
	</div>

	<script>
		console.log('==VERSION 2.0');
		
		const videoSelect = document.querySelector('select#videoSource');
		const video = document.querySelector('video');
		const canvas = document.querySelector('canvas');
		let localMediaStream = null;
		
		////////////////////////////////////////////////

		navigator.mediaDevices.enumerateDevices()
			.then(gotDevices).then(getStream).catch(handleError);

		videoSelect.onchange = getStream;

		function gotDevices(deviceInfos) {
			for (let i = 0; i !== deviceInfos.length; ++i) {
				const deviceInfo = deviceInfos[i];
				const option = document.createElement('option');
				option.value = deviceInfo.deviceId;
				if (deviceInfo.kind === 'videoinput') {
					option.text = deviceInfo.label || 'camera ' + (videoSelect.length + 1);
					videoSelect.appendChild(option);
				} 
			}
		}

		////////////////////////////////////////////////

		function getStream() {
		var constraints = {
			video: {
// 				width: 1280,
// 				height: 720
				deviceId: { exact: videoSelect.value }
			}
		};
		
		navigator.mediaDevices.getUserMedia(constraints)
// 			.then(function(stream) {
// 				onMediaStream(stream);
// 			})
// 			.catch(function(err) {
// 				onMediaFail(err);
// 			});
			.then(onMediaStream).catch(onMediaFail);
		}// getStream()
		
		function onMediaStream(stream) {
			window.URL = window.URL || window.webkitURL;
			video.srcObject = stream;
			console.log('==video.srcObject:', video.srcObject)
			console.log('==video.readyState:', video.readyState)
			localMediaStream = stream;
			video.onloadedmetadata = function(e) {
				console.log('==onloadedmetadata...')
				let h = video.height;
				let w = h * video.videoWidth/video.videoHeight;
				canvas.width = w;
				canvas.height = h;
			};
		}

		function onMediaFail(e) {
			alert('Camera did not work.', e.message);
		}

		function snapshot() {
			if (localMediaStream) {
				let ctx = canvas.getContext('2d');
				ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
			}
		}
	</script>
