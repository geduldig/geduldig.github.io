<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<body>
	<div style='display:flex'>
		<div style='justify-content:flex-start'>
			<!-- VIDEO AND CANVAS -->
			<div>
				<video id='video' autoplay='true' style='display:block'></video>
			</div>
		</div>
		<div style='justify-content:flex-start'>
			<!-- VIDEO SOURCE CHOOSER -->
			<div class="select" style='margin-left:5px; padding:5px;'>
				<label for="videoSource">Video source: </label>
				<select id="videoSource"></select>
			</div>
			<br>
			<!-- SLIDER CONTROL -->
			<div style='display:inline-block'>
				<div class='controls' style='display:none'>
					<div style='margin-left:5px; padding:5px; font-size:.5em'>
						<div id='sliders' style='border-style:solid; border-width:1px; display:inline-block'/>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script src='https://code.jquery.com/jquery-latest.min.js'></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src='js/JQueryUISlider.js'></script>
	<script src='js/webcam.js'></script>

	<script>
		console.log('==VERSION 1.1');

		let videoScale = 0.5;
		const videoSelect = document.querySelector('select#videoSource');
		const video = document.querySelector('#video');

		document.addEventListener("DOMContentLoaded", function(event) {
			videoSelect.onchange = () => {
				setupCamera(video, videoSelect.value, (err, stream) => {
					if (err)
						alert('WEBCAM INITIALIZATION FAILED: ' + JSON.stringify(err));
					else {
						showControls();
						resizeVideo(videoScale);
					}
				});
			};

			discoverCameras((err, {label, id}) => {
				const option = document.createElement('option');
				option.value = id;
				option.text = label;
				videoSelect.appendChild(option);
				if (videoSelect.length === 1) {
					option.setAttribute('selected', 'selected');
					//videoSelect.dispatchEvent(new Event('change'))
				}
			});
		});
		
		function showControls() {
			var controls = document.getElementsByClassName('controls');
			for (var i=0; i < controls.length; i++)
				controls[i].style.display = '';
		}

		function resizeVideo(scale) {
			videoScale = scale;
			if (video.videoWidth/video.videoHeight > screen.width/screen.height) {
				video.width = screen.width * videoScale;
				video.height = video.width*video.videoHeight/video.videoWidth;
			}
			else {
				video.height = screen.height * videoScale;
				video.width = video.height*video.videoWidth/video.videoHeight;
			}
		}

		// -- Sliders --

		var slider_data = [
			{ label:'SIZE', options:{min:0.2, max:.8, step:.1, value:videoScale}, slide:function(value) {
				resizeVideo(value);}},
		];
		for (var i = 0; i < slider_data.length; i++)
			JQueryUISlider.CreateSlider('#sliders', slider_data[i]);
		JQueryUISlider.AddSliderStyle();
	</script>
