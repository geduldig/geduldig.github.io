<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="style/style.css">

<body>
	<div style='display:flex'>
		<div style='justify-content:flex-start'>
			<!-- VIDEO AND CANVAS -->
			<div>
				<video id='video' autoplay='true' style='display:none'></video>
				<canvas id='canvas'></canvas>
			</div>
		</div>
		<div id='menu' style='display:none'>
			<!-- VIDEO SOURCE CHOOSER -->
			<div class="select">
				<label for="videoSource">Video </label>
				<span><select id="videoSource"></select></span>
			</div>
			<!-- SLIDER CONTROLS -->
			<div style='display:inline-block'>
				<div class='controls'>
					<div id='sliders'/>
				</div>					
			</div>
			<!-- PRESET BUTTONS -->
			<div style='display:inline-block'>
				<div class='controls'>
					<label for="presets">Presets </label>
					<span><div id='presets' style='display:inline-block'/></span>
				</div>					
			</div>
			<!-- SNAPSHOT -->
			<div style='display:inline-block'>
				<div class='controls'>
					<a id='save-snapshot' onclick='saveSnapshot()' href='#'>Save snapshot</a>
					<img id='snapshot-img' style='display:none'></img>
				</div>
			</div>
		</div>
	</div>

	<!-- SHADERS -->

	<script id='vshader' type='text/plain'>
		attribute vec2 position;
		void main(void) {
			gl_Position = vec4(position, 0, 1);
		}
	</script>

	<script id='fshader' type='text/plain'>
		precision mediump float;
		uniform sampler2D sampler0;
		uniform float width, height;
		uniform float K1, K2;
		vec3 posterize(vec3 rgb) {
			float gamma = .6;
			float ncolors = 8.;
			rgb = pow(rgb, vec3(gamma, gamma, gamma));
			rgb = rgb * ncolors;
			rgb = floor(rgb);
			rgb = rgb / ncolors;
			return pow(rgb, vec3(1./gamma));
		}
		void main(void) {
			const mat3 Gx = mat3(-1, 0, 1, -2, 0, 2, -1, 0, 1);
			const mat3 Gy = mat3(-1, -2, -1, 0, 0, 0, 1, 2, 1);
			vec2 dim = vec2(width, height);
			vec2 p = vec2(gl_FragCoord.x, height - gl_FragCoord.y);
			vec2 x0y0 = (p + vec2(-1, -1)) / dim;
			vec2 x0y1 = (p + vec2(-1,  0)) / dim;
			vec2 x0y2 = (p + vec2(-1,  1)) / dim;
			vec2 x1y0 = (p + vec2(0, -1)) / dim;
			vec2 x1y1 = (p + vec2(0,  0)) / dim;
			vec2 x1y2 = (p + vec2(0,  1)) / dim;
			vec2 x2y0 = (p + vec2(1, -1)) / dim;
			vec2 x2y1 = (p + vec2(1,  0)) / dim;
			vec2 x2y2 = (p + vec2(1,  1)) / dim;

			vec4 tx0y0 = texture2D(sampler0, x0y0);
			vec4 tx0y1 = texture2D(sampler0, x0y1);
			vec4 tx0y2 = texture2D(sampler0, x0y2);
			vec4 tx1y0 = texture2D(sampler0, x1y0);
			vec4 tx1y1 = texture2D(sampler0, x1y1);
			vec4 tx1y2 = texture2D(sampler0, x1y2);
			vec4 tx2y0 = texture2D(sampler0, x2y0);
			vec4 tx2y1 = texture2D(sampler0, x2y1);
			vec4 tx2y2 = texture2D(sampler0, x2y2);

			mat3 id = Gx;
			vec4 colorGx =
				id[0][0] * tx0y0 + id[0][1] * tx1y0 + id[0][2] * tx2y0 +
				id[1][0] * tx0y1 + id[1][1] * tx1y1 + id[1][2] * tx2y1 +
				id[2][0] * tx0y2 + id[2][1] * tx1y2 + id[2][2] * tx2y2;
			id = Gy;
			vec4 colorGy =
				id[0][0] * tx0y0 + id[0][1] * tx1y0 + id[0][2] * tx2y0 +
				id[1][0] * tx0y1 + id[1][1] * tx1y1 + id[1][2] * tx2y1 +
				id[2][0] * tx0y2 + id[2][1] * tx1y2 + id[2][2] * tx2y2;

			float fColorGx = colorGx.r;
			float fColorGy = colorGy.r;
			float norm = fColorGx * fColorGx + fColorGy * fColorGy;
			norm = clamp(1. - K1*sqrt(norm), 0., 1.);
			vec4 edges = vec4(norm, norm, norm, 1.);
			vec2 st = vec2(gl_FragCoord.s/width, 1. - gl_FragCoord.t/height);
			vec3 rgb = texture2D(sampler0, st).rgb;
			rgb = posterize(rgb);
			rgb = clamp(rgb+K2, 0., 1.);
			gl_FragColor = vec4(rgb, 1.) * edges;
		}
	</script>

	<!-- MAIN PROGRAM -->

	<script src='https://code.jquery.com/jquery-latest.min.js'></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src='js/jquerySlider.js'></script>
    <script src='js/webglShader.js'></script>
    <script src='js/webglTexture.js'></script>
	<script src='js/webcam.js'></script>
	<script src='js/common.js'></script>

	<script>
		console.log("VERSION 1.1");

		// -- Shader control knobs --
		
		const k1 = gl.getUniformLocation(program, 'K1');
		const k2 = gl.getUniformLocation(program, 'K2');

		// -- Sliders --

		const sliders = [
		{ label:'VIDEO SCALE', options:{min:0.2, max:1., step:.1}, slide:function(value) {
				resizeCanvas(value); startAnimation();}},
			{ label:'LINE DENSITY', options:{min:.5, max:5., step:.1}, slide:function(value) {
				gl.uniform1f(k1, value);}},
			{ label:'COLOR', options:{min:0., max:1., step:.01}, slide:function(value) {
				gl.uniform1f(k2, value);}}
		];

		createSliders(sliders);

		// -- Presets --

		sliders[0].update(.5);

		createPreset('1', () => {
			sliders[1].update(2.);
			sliders[2].update(.25);
		}).onclick();

		createPreset('2', () => {
			sliders[1].update(1.);
			sliders[2].update(.5);
		});
</script>
