<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="style/style.css" />

<body>
	<div style='display:flex'>
		<div style='justify-content:flex-start'>
			<!-- VIDEO -->
			<div>
				<video id='video' autoplay='true' style='display:block' onclick=toggleMenu()></video>
			</div>
		</div>
		<div id='menu' style='display:none'>
			<div>
				<span id='closeMenu' style='display:inline-block'>
					<button onclick=hideMenu()></button>
				</span>
			</div>
			<!-- VIDEO SOURCE CHOOSER -->
			<div class="select">
				<label for="videoSource">Video </label>
				<span><select id="videoSource"></select></span>
				<span id='facingMode' style='display:inline-block'>
					<button class='controls' onclick=toggleFacingMode()></button>
				</span>
			</div>
			<!-- SLIDER CONTROLS -->
			<div style='display:inline-block'>
				<div class='controls'>
					<div id='sliders'/>
				</div>					
			</div>
		</div>
	</div>

	<script src='https://code.jquery.com/jquery-latest.min.js'></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src='js/jquerySlider.js'></script>
	<script src='js/webcam.js'></script>

	<script>
		console.log('==VERSION 1.1');

		// -- DOM elements --

		const menu = document.querySelector('#menu');
		const videoSelect = document.querySelector('select#videoSource');
		const video = document.querySelector('#video');

		const isMobileDevice =
			navigator.userAgent.match(/Android/i) ||
			navigator.userAgent.match(/webOS/i) ||
			navigator.userAgent.match(/iPhone/i) ||
			navigator.userAgent.match(/iPad/i) ||
			navigator.userAgent.match(/iPod/i) ||
			navigator.userAgent.match(/BlackBerry/i) ||
			navigator.userAgent.match(/Windows Phone/i);

		let videoScale = 1.0;
		let rearCamera = false;

		// -- UI events --

		document.addEventListener('DOMContentLoaded', function(event) {
			discoverCameras((err, {label, id}) => {
				const option = document.createElement('option');
				option.value = id;
				option.text = label;
				videoSelect.appendChild(option);
				if (videoSelect.length === 1 || option.text.indexOf('Built-in') !== -1) {
					option.setAttribute('selected', 'selected');
					videoSelect.dispatchEvent(new Event('change'));
				}
			});

			if (!isMobileDevice)
				document.querySelector('#facingMode').style.display = 'none';
		});

		videoSelect.onchange = () => {
			const constraints = {
				video: { 
					width: 1280, 
					deviceId: videoSelect.value ? { exact:videoSelect.value } : null, 
					facingMode: rearCamera ? { exact:'environment' } : 'user'
				}
			};

			setupCamera(video, constraints, (err, stream) => {
				if (err)
					alert('WEBCAM FAILED: ' + JSON.stringify(err));
				else {
					showControls();
					resizeVideo(videoScale);
					showMenu();
				}
			});
		};

		// -- Tasks --

		function showMenu() {
			menu.style.display = 'block';
			if (isMobileDevice)
				menu.style.zoom = (video.width / menu.clientWidth).toString();
		}

		function hideMenu() {
			menu.style.display = 'none';
		}

		function toggleMenu() {
			menu.style.display === 'none' ? showMenu() : hideMenu();;
		}

		function toggleFacingMode() {
			rearCamera = !rearCamera;
			videoSelect.onchange();
		}

		function showControls() {
			var controls = document.getElementsByClassName('controls');
			for (var i=0; i < controls.length; i++)
				controls[i].style.display = '';
		}

		function resizeVideo(scale) {
			videoScale = scale;
			if (video.videoWidth / video.videoHeight > window.innerWidth / window.innerheight) {
				video.width = window.innerWidth * videoScale;
				video.height = video.width * video.videoHeight / video.videoWidth;
			}
			else {
				video.height = window.innerHeight * videoScale;
				video.width = video.height * video.videoWidth / video.videoHeight;
			}
		}

		// -- Sliders --

		const sliders = [
			{ label:'VIDEO SCALE', options:{min:0.2, max:1., step:.01}, slide:function(value) {
				resizeVideo(value);}},
		];

		for (var i = 0; i < sliders.length; i++)
			jQuerySlider.CreateSlider('#sliders', sliders[i]);
		jQuerySlider.AddSliderStyle();

		// -- Presets --

		sliders[0].update(1.0);
	</script>
