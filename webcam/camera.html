<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<link rel="stylesheet" href="style/style.css" />

<body>
	<main role='main' class='container-fluid test'>
		<div class='row'>
			<div>
				<!-- VIDEO -->
				<div>
					<video id='video' autoplay='true' style='display:block' onclick=toggleMenu()></video>
				</div>
			</div>
			<div id='menu' class='col-lg-6' style='display:none'>
				<div>
					<span id='closeMenu' style='display:inline-block'>
						<button onclick=hideMenu()></button>
					</span>
				</div>
				<!-- VIDEO SOURCE CHOOSER -->
				<div class='d-flex flex-row bd-highlight mb-3'>
					<label class='left-label p-2 bd-highlight' for='videoSource'>Video</label>
					<select class='p-2 bd-highlight' id='videoSource' class='form-control'></select>
					<button id='facingMode' class='p-2 bd-highlight btn btn-primary' onclick=toggleFacingMode()><img src='style/flipCamera.png' width='30' /></button>
					<button id='takePhoto' class='p-2 bd-highlight btn btn-primary' onclick=videoSelect.onchange()><img src='style/photo.png' width='30' /></button>
				</div>
				<!-- SLIDER CONTROLS -->
				<div class='controls range-field'>
					<form id='sliders' />
				</div>
			</div>
		</div>
	</main>

	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" crossorigin="anonymous"></script>
	<script src='js/webcam.js'></script>

	<script>
		console.log('==VERSION 1.5');
		alert('camera v 1.5')

		const isMobileDevice = 
			navigator.userAgent.match(/Android/i) ||
			navigator.userAgent.match(/webOS/i) ||
			navigator.userAgent.match(/iPhone/i) ||
			navigator.userAgent.match(/iPad/i) ||
			navigator.userAgent.match(/iPod/i) ||
			navigator.userAgent.match(/BlackBerry/i) ||
			navigator.userAgent.match(/Windows Phone/i);

		// -- DOM elements --

		const menu = document.querySelector('#menu');
		const videoSelect = document.querySelector('select#videoSource');
		const video = document.querySelector('#video');

		let videoScale = 1.0;
		let rearCamera = false;

		if (!isMobileDevice) {
			CreateSlider('slider0', 'Video scale', 0.2, 1.0, 0.01, () => {
				resizeVideo(document.querySelector('#slider0 > input').value);
			});
			document.querySelector('#slider0 > input').value = 1.0;
		}

		// -- UI events --

		document.addEventListener('DOMContentLoaded', function(event) {
			//enableRearCamera(() => {
				discoverCameras((err, {label, id}) => {
					const option = document.createElement('option');
					option.value = id;
					option.text = label;
					videoSelect.appendChild(option);
					if (videoSelect.length === 1 || option.text.indexOf('Built-in') !== -1) {
						option.setAttribute('selected', 'selected');
						videoSelect.dispatchEvent(new Event('change'));
					}
				});
			//});
		});

		videoSelect.onchange = () => {
			const constraints = {
				video: { 
					width: 1280, 
					// deviceId: videoSelect.value ? { exact:videoSelect.value } : null, 
					// facingMode: rearCamera ? { exact:'environment' } : 'user'
				}
			};

			setupCamera(video, constraints, (err, stream) => {
				if (err) 
					alert('Problem: ' + err);
				else {
					showControls();
					resizeVideo(videoScale);
					showMenu();
				}
			});
		};

		// -- Tasks --

		function enableRearCamera(callback) {
			let constraints = {
				video: {
					facingMode: { exact:'environment' }
				}
			};			
			setupCamera(video, constraints, (err, stream) => {
				if (stream)
					stream.getTracks[0].stop();
				document.querySelector('#facingMode').style.display = err ? 'none' : 'block';
				callback();
			});
		}

		function showMenu() {
			menu.style.display = 'block';
		}

		function hideMenu() {
			menu.style.display = 'none';
		}

		function toggleMenu() {
			menu.style.display === 'none' ? showMenu() : hideMenu();;
		}

		function toggleFacingMode() {
			rearCamera = !rearCamera;
			videoSelect.onchange();
		}

		function showControls() {
			var controls = document.getElementsByClassName('controls');
			for (var i=0; i < controls.length; i++)
				controls[i].style.display = '';
		}

		function resizeVideo(scale) {
			videoScale = scale;
			if (video.videoWidth / video.videoHeight > window.innerWidth / window.innerheight) {
				video.width = window.innerWidth * videoScale;
				video.height = video.width * video.videoHeight / video.videoWidth;
			}
			else {
				video.height = window.innerHeight * videoScale;
				video.width = video.height * video.videoWidth / video.videoHeight;
			}
		}

		function CreateSlider(id, name, min, max, step, oninput) {
			const slider = document.createElement('div');
			slider.id = id;
			slider.className = 'd-flex flex-row bd-highlight mb-3';
			const label = document.createElement('div');
			label.className = 'p-2 bd-highlight flex-nowrap right-label';
			label.for = id;
			label.innerText = name;
			const input = document.createElement('input');
			input.className = 'col-sm-10 custom-range';
			input.type = 'range';
			input.min = min;
			input.max = max;
			input.step = step
			input.oninput = oninput;
			slider.appendChild(input);
			slider.appendChild(label);
			document.querySelector('#sliders').appendChild(slider);
			return (val) => { 
				input.value = val;
				input.oninput();
			};
		}
	</script>
