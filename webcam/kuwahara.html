<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
<link rel="stylesheet" href="style/style.css?v=2.5">

<body>
	<main role='main' class='container-fluid test no-spacing'>
		<!-- VIDEO -->
		<div class='row no-spacing'>
			<div class='col-sm-12 no-spacing'>
				<div>
					<video id='video' autoplay playsinline style='display:none'></video>
					<canvas id='canvas' onclick=toggleMenu()></canvas>
				</div>
			</div>
			<div id='on-boarding' class='fade-in' onclick=hideOnBoarding() style='display:none'>
				Click image to display options.
			</div>
		</div>

		<!-- MENU -->
		<div class='row'>
			<div id='menu' class='col-lg-6 col-sm-12 fade-in' style='display:none'>
				<div>
					<div id='goBack' style='display:block'>
						<button class='fa fa-arrow-left fa-2x' onclick=goToParentPage()></button>
					</div>
					<div id='closeMenu' style='display:block'>
						<button class='fa fa-times fa-2x' onclick=hideMenu()></button>
					</div>
				</div>
				<!-- VIDEO SOURCE CHOOSER -->
				<div class='d-flex flex-row bd-highlight mb-0 mt-4'>
					<label class='left-label p-2 bd-highlight' for='videoSource'>Camera</label>
					<select class='p-2 bd-highlight' id='videoSource' class='form-control'></select>
					<button id='facingMode' class='p-2 bd-highlight btn btn-primary' onclick=toggleFacingMode()>
						<img src='style/flipCamera.png' width='30'/>
					</button>
					<button id='snapshot' class='p-2 bd-highlight btn btn-primary' onclick=saveSnapshot()>
						<img src='style/photo.png' width='30'/>
						<a id='snapshot-link' href='#'></a>
						<img id='snapshot-img' style='display:none'/>
					</button>
				</div>
				<!-- SLIDER CONTROLS -->
				<div class='controls range-field m-0 p-0'>
					<form id='sliders'/>
				</div>
				<!-- PRESET AND SNAPSHOT BUTTONS -->
				<div style='display:inline-block'>
					<div class='d-flex flex-row bd-highlight mb-3 mt-0'>
						<label id='presets-label' class='left-label p-2 bd-highlight' for='presets'>Presets</label>
						<span id='presets' style='display:inline-block'></span>
					</div>					
				</div>
			</div>
		</div>
	</main>

	<!-- SHADERS -->

	<script id='vshader' type='text/plain'>
		attribute vec2 position;
		void main(void) {
			gl_Position = vec4(position, 0, 1);
		}
	</script>

	<script id='fshader' type='text/plain'>
		precision mediump float;
		uniform sampler2D sampler0;
		uniform float width, height;
		const int radius = 5;
		const float n = float((radius + 1) * (radius + 1));
		void main (void) {
			vec2 src_size = vec2(width, height);
			vec2 uv = vec2(gl_FragCoord.s/width, 1. - gl_FragCoord.t/height);
			vec3 m[4];
			vec3 s[4];
			m[0] = m[1] = m[2] = m[3] = vec3(0.0);
			s[0] = s[1] = s[2] = s[3] = vec3(0.0);
			for (int j = -radius; j <= 0; ++j)  {
				for (int i = -radius; i <= 0; ++i)  {
					vec3 c = texture2D(sampler0, uv + vec2(i,j) / src_size).rgb;
					m[0] += c;
					s[0] += c * c;
				}
			}
			for (int j = -radius; j <= 0; ++j)  {
				for (int i = 0; i <= radius; ++i)  {
					vec3 c = texture2D(sampler0, uv + vec2(i,j) / src_size).rgb;
					m[1] += c;
					s[1] += c * c;
				}
			}
			for (int j = 0; j <= radius; ++j)  {
				for (int i = 0; i <= radius; ++i)  {
					vec3 c = texture2D(sampler0, uv + vec2(i,j) / src_size).rgb;
					m[2] += c;
					s[2] += c * c;
				}
			}
			for (int j = 0; j <= radius; ++j)  {
				for (int i = -radius; i <= 0; ++i)  {
					vec3 c = texture2D(sampler0, uv + vec2(i,j) / src_size).rgb;
					m[3] += c;
					s[3] += c * c;
				}
			}
			float min_sigma2 = 1e+2;
			for (int k = 0; k < 4; ++k) {
				m[k] /= n;
				s[k] = abs(s[k] / n - m[k] * m[k]);
				float sigma2 = s[k].r + s[k].g + s[k].b;
				if (sigma2 < min_sigma2) {
					min_sigma2 = sigma2;
					gl_FragColor = vec4(m[k], 1.0);
				}
			}
		}
	</script>

	<!-- MAIN PROGRAM -->

	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src='js/webglShader.js'></script>
    <script src='js/webglTexture.js'></script>
	<script src='js/webcam.js'></script>
	<script src='js/common.js'></script>

	<script>
		console.log("VERSION 2.1");

		// -- Sliders --

		const maxScale = isMobileDevice ? 2.0 : 1.0;
		CreateSlider('slider0', 'Video scale', 0.2, maxScale, 0.01, () => {
			resizeCanvas(document.querySelector('#slider0 > input').value);
		});
	</script>
