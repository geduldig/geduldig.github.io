<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet" href="style/style.css">

<body>
	<div style='display:flex'>
		<div style='justify-content:flex-start'>
			<!-- VIDEO AND CANVAS -->
			<div>
				<video id='video' autoplay='true' style='display:none'></video>
				<canvas id='canvas' onclick=toggleMenu()></canvas>
			</div>
		</div>
		<div id='menu' style='display:none'>
			<div>
				<span id='closeMenu' style='display:inline-block'>
					<button onclick=hideMenu()></button>
				</span>
			</div>
			<!-- VIDEO SOURCE CHOOSER -->
			<div class="select">
				<label for="videoSource">Video </label>
				<span><select id="videoSource"></select></span>
				<span id='facingMode' style='display:inline-block'>
					<button class='controls' onclick=toggleFacingMode()></button>
				</span>
			</div>
			<!-- SLIDER CONTROLS -->
			<div style='display:inline-block'>
				<div class='controls'>
					<div id='sliders'/>
				</div>					
			</div>
			<!-- PRESET BUTTONS -->
			<div style='display:inline-block'>
				<div class='controls'>
					<label for="presets">Presets </label>
					<span><div id='presets' style='display:inline-block'/></span>
				</div>					
			</div>
			<!-- SNAPSHOT -->
			<div id='snapshot' style='display:inline-block'>
				<div class='controls'>
					<a id='save-snapshot' onclick='saveSnapshot()' href='#'>Save snapshot</a>
					<img id='snapshot-img' style='display:none'></img>
				</div>
			</div>
		</div>
	</div>

	<!-- SHADERS -->

	<script id='vshader' type='text/plain'>
		attribute vec2 position;
		void main(void) {
			gl_Position = vec4(position, 0, 1);
		}
	</script>

	<script id='fshader' type='text/plain'>
		precision mediump float;
		uniform sampler2D sampler0;
		uniform float width, height;
		uniform float R, G, B, T;
		const int radius = 3;
		const float n = float((radius + 1) * (radius + 1));
		const vec3 W = vec3(0.2125, 0.7154, 0.0721);

		vec3 saturate(vec3 irgb) {
			vec3 L = vec3(R, G, B);
			float luminance = dot(irgb, W);
			vec2 st = vec2(gl_FragCoord.s/width, 1. - gl_FragCoord.t/height);
			vec3 target = L*vec3(luminance, luminance, luminance);
			return mix(target, irgb, T);
		}

		void main (void) {
			vec2 src_size = vec2(width, height);
			vec2 uv = vec2(gl_FragCoord.s/width, 1. - gl_FragCoord.t/height);
			vec3 m[4];
			vec3 s[4];
			m[0] = m[1] = m[2] = m[3] = vec3(0.0);
			s[0] = s[1] = s[2] = s[3] = vec3(0.0);
			for (int j = -radius; j <= 0; ++j)  {
				for (int i = -radius; i <= 0; ++i)  {
					vec3 c = texture2D(sampler0, uv + vec2(i,j) / src_size).rgb;
					m[0] += c;
					s[0] += c * c;
				}
			}
			for (int j = -radius; j <= 0; ++j)  {
				for (int i = 0; i <= radius; ++i)  {
					vec3 c = texture2D(sampler0, uv + vec2(i,j) / src_size).rgb;
					m[1] += c;
					s[1] += c * c;
				}
			}
			for (int j = 0; j <= radius; ++j)  {
				for (int i = 0; i <= radius; ++i)  {
					vec3 c = texture2D(sampler0, uv + vec2(i,j) / src_size).rgb;
					m[2] += c;
					s[2] += c * c;
				}
			}
			for (int j = 0; j <= radius; ++j)  {
				for (int i = -radius; i <= 0; ++i)  {
					vec3 c = texture2D(sampler0, uv + vec2(i,j) / src_size).rgb;
					m[3] += c;
					s[3] += c * c;
				}
			}
			float min_sigma2 = 1e+2;
			for (int k = 0; k < 4; ++k) {
				m[k] /= n;
				s[k] = abs(s[k] / n - m[k] * m[k]);
				float sigma2 = s[k].r + s[k].g + s[k].b;
				if (sigma2 < min_sigma2) {
					min_sigma2 = sigma2;
					gl_FragColor = vec4(saturate(m[k]), 1.0);
				}
			}
		}
	</script>

	<!-- MAIN PROGRAM -->

	<script src='https://code.jquery.com/jquery-latest.min.js'></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src='js/jquerySlider.js'></script>
    <script src='js/webglShader.js'></script>
    <script src='js/webglTexture.js'></script>
	<script src='js/webcam.js'></script>
	<script src='js/common.js'></script>

	<script>
		console.log("VERSION 1.1");

		// -- Shader control knobs --

		const kr = gl.getUniformLocation(program, 'R');
		const kg = gl.getUniformLocation(program, 'G');
		const kb = gl.getUniformLocation(program, 'B');
		const kt = gl.getUniformLocation(program, 'T');

		// -- Sliders --

		const sliders = [
			{ label:'VIDEO SCALE', options:{min:0.2, max:1., step:.01}, slide:function(value) {
				resizeCanvas(value); startAnimation();}},
			{ label:'Red', options:{min:0, max:2, step:.01}, slide:function(value) {
				gl.uniform1f(kr, value);}},
			{ label:'Green', options:{min:0, max:2, step:.01}, slide:function(value) {
				gl.uniform1f(kg, value);}},
			{ label:'Blue', options:{min:0, max:2, step:.01}, slide:function(value) {
				gl.uniform1f(kb, value);}},
			{ label:'Saturation', options:{min:-10, max:10, step:.1}, slide:function(value) {
				gl.uniform1f(kt, value);}}
		];

		createSliders(sliders);

		// -- Presets --

		sliders[0].update(1.0);
		sliders[4].update(5.);

		const rgb = [
			[0.5, 0.5, 0.5],
			[0.9, 1.1, 1.4],
			[1.2, 1.1, 2.0],
			[1.6, 0.8, 1.6],
			[1.2, 1.1, 1.1]
		];

		for (let irgb = 0; irgb < rgb.length; irgb++) {
			const p = createPreset((irgb+1).toString(), () => {
				sliders[1].update(rgb[irgb][0]);
				sliders[2].update(rgb[irgb][1]);
				sliders[3].update(rgb[irgb][2]);
			});
			if (irgb === 0) p.onclick();
		}
	</script>
