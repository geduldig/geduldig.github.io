<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<body> 
	<div style='display:flex'>
		<div style='justify-content:flex-start'>
			<!-- VIDEO AND CANVAS -->
			<video id='video' autoplay='true' style='display:none'></video>
			<canvas id='c'></canvas>
			<div style=''>
				<canvas id='c1' style='position:absolute;z-index:0'></canvas>
				<canvas id='c2' style='position:absolute;z-index:1'></canvas>
			</div>
		</div>
		<div style='justify-content:flex-start'>
			<!-- VIDEO SOURCE CHOOSER -->
			<div class="select" style='margin-left:5px; padding:5px;'>
				<label for="videoSource">Video source: </label>
				<select id="videoSource"></select>
			</div>
			<br>
			<!-- SLIDER CONTROL -->
			<div style='display:inline-block'>
				<div class='controls' style='display:none'>
					<div style='margin-left:5px; padding:5px; font-size:.5em'>
						<div id='sliders' style='border-style:solid; border-width:1px; display:inline-block'/>
					</div>
				</div>
			</div>
		</div>
	</div>
		
	<script src='https://code.jquery.com/jquery-latest.min.js'></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src='js/JQueryUISlider.js'></script>
	<script src='js/video-utils.js'></script>
	<script src='js/headtrackr.js'></script>

	<script>
		console.log("*** VIDEO_HEADTRACK: VERSION 5.2 ***");
		
		const videoSelect = document.querySelector('select#videoSource');
		const video = document.getElementById('video');
		const canvas = document.getElementById('c');
		const canvas1 = document.getElementById('c1');
		const canvas2 = document.getElementById('c2');
		const context2d = canvas2.getContext('2d');
		let videoScale = 0.8;
		let ht = null;
		let setupComplete = false;
		
		document.addEventListener("DOMContentLoaded", function(event) {
			findCameras(videoSelect, video, function(err, stream) {
				if (err)
					alert('VIDEO INITIALIZATION FAILED: ' + err.name);
				else if (setupComplete != true) {
					showControls();
					resizeCanvas(videoScale);
					if (ht != null)
						ht.stop();
					ht = new headtrackr.Tracker({ui:true, headPosition:false, calcAngles:true});
					ht.init(video, canvas1, false);
					ht.start();
				}
			});
		});
		
		function showControls() {
			var controls = document.getElementsByClassName('controls');
			for (var i=0; i < controls.length; i++)
				controls[i].style.display = '';
		}

		function resizeCanvas(scale) {
			videoScale = scale
			if (video.videoWidth/video.videoHeight > screen.width/screen.height) {
				canvas1.width = screen.width * videoScale;
				canvas1.height = canvas1.width*video.videoHeight/video.videoWidth;
			}
			else {
				canvas1.height = screen.height * videoScale;
				canvas1.width = canvas1.height*video.videoWidth/video.videoHeight;
			}
			canvas2.width = canvas1.width;
			canvas2.height = canvas1.height;
		}
		
		document.addEventListener('headtrackrStatus', function (event) {
			//console.log("*** STATUS: " + event.status);
			if (event.status == 'whitebalance') 
				if (!setupComplete)
					setup();
		});

		document.addEventListener('facetrackingEvent', function (event) {
			drawBox(event.x, event.y, event.width, event.height, event.angle);
		});

		function setup() {
			setupComplete = true;
			var vidW = video.videoWidth*videoScale;;
			var vidH = video.videoHeight*videoScale;
			context2d.strokeStyle = '#ffff00';
		}
				
		function drawBox(cx, cy, w, h, a) {
			context2d.clearRect(0, 0, context2d.canvas.width, context2d.canvas.height);
			context2d.save();
			context2d.translate(cx-w/2, cy-h/2);
			context2d.rotate(a-Math.PI/2);
			context2d.beginPath();
			context2d.moveTo(0, 0);
			context2d.lineTo(w, 0);
			context2d.lineTo(w, h);
			context2d.lineTo(0, h);
			context2d.lineTo(0, 0);
			context2d.stroke();
			context2d.restore();
		}

		// -- Sliders --

		var slider_data = [
			{ label:'SIZE', options:{min:0.2, max:.8, step:.1, value:videoScale}, slide:function(value) {
				resizeCanvas(value);}},
		];
		for (var i = 0; i < slider_data.length; i++)
			JQueryUISlider.CreateSlider('#sliders', slider_data[i]);
		JQueryUISlider.AddSliderStyle();
	</script>
