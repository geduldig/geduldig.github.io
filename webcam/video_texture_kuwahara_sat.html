<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css">
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />

<body>
	<div>
		<!-- VIDEO AND CANVAS -->
		<video id='video' autoplay='true' style='display:none'></video>
		<canvas id='canvas'></canvas>
		<!-- SLIDER CONTROL -->
		<div style='display:inline-block'>
			<div class='controls' style='display:none'>
				<div style='margin-left:5px; padding:5px; font-size:.5em'>
					<button id='saturation-btn' onclick='saturation()'>Toggle Saturation</button>
					<br>
					<div id='sliders' style='border-style:solid; border-width:1px; display:inline-block'/>
				</div>
			</div>
		</div>
	</div>
	<div>
		<!-- SNAPSHOT CONTROL -->
		<div class='controls' style='display:none'>
			<div style='margin-top:10px'>
				<div>
					<a id='take-snapshot' onclick='snapshot()' href="#" style='background-color:black'>Take snapshot</a>
					<a id='save-snapshot' onclick='save()' href="#" style='background-color:black' download='photo_blur.png'>Save snapshot</a>
				</div>
				<img id='snapshot-img' download></img>
			</div>
		</div>
	</div>

	<script src='https://code.jquery.com/jquery-latest.min.js'></script>
	<script src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js'></script>
	<script src='js/JQueryUISlider.js'></script>
	<script src='js/webgl-utils.js'></script>
	<script src='js/video-utils.js'></script>

	<!-- SHADERS -->

	<script id='vshader' type='text/plain'>
		attribute vec2 position;
		void main(void) {
			gl_Position = vec4(position, 0, 1);
		}
	</script>

	<script id='fshader' type='text/plain'>
		precision highp float;
		uniform sampler2D sampler0;
		uniform float width, height;
		uniform float R, G, B, T;
		const int radius = 4;
		const float n = float((radius + 1) * (radius + 1));
		const vec3 W = vec3(0.2125, 0.7154, 0.0721);

		vec3 saturate(vec3 irgb) {
			vec3 L = vec3(R, G, B);
			float luminance = dot(irgb, W);
			vec2 st = vec2(gl_FragCoord.s/width, 1. - gl_FragCoord.t/height);
			vec3 target = L*vec3(luminance, luminance, luminance);
			return mix(target, irgb, T);
		}

		void main (void) {
			vec2 src_size = vec2(width, height);
			vec2 uv = vec2(gl_FragCoord.s/width, 1. - gl_FragCoord.t/height);
			vec3 m[4];
			vec3 s[4];
			m[0] = m[1] = m[2] = m[3] = vec3(0.0);
			s[0] = s[1] = s[2] = s[3] = vec3(0.0);
			for (int j = -radius; j <= 0; ++j)  {
				for (int i = -radius; i <= 0; ++i)  {
					vec3 c = texture2D(sampler0, uv + vec2(i,j) / src_size).rgb;
					m[0] += c;
					s[0] += c * c;
				}
			}
			for (int j = -radius; j <= 0; ++j)  {
				for (int i = 0; i <= radius; ++i)  {
					vec3 c = texture2D(sampler0, uv + vec2(i,j) / src_size).rgb;
					m[1] += c;
					s[1] += c * c;
				}
			}
			for (int j = 0; j <= radius; ++j)  {
				for (int i = 0; i <= radius; ++i)  {
					vec3 c = texture2D(sampler0, uv + vec2(i,j) / src_size).rgb;
					m[2] += c;
					s[2] += c * c;
				}
			}
			for (int j = 0; j <= radius; ++j)  {
				for (int i = -radius; i <= 0; ++i)  {
					vec3 c = texture2D(sampler0, uv + vec2(i,j) / src_size).rgb;
					m[3] += c;
					s[3] += c * c;
				}
			}
			float min_sigma2 = 1e+1;
			for (int k = 0; k < 4; ++k) {
				m[k] /= n;
				s[k] = abs(s[k] / n - m[k] * m[k]);
				float sigma2 = s[k].r + s[k].g + s[k].b;
				if (sigma2 < min_sigma2) {
					min_sigma2 = sigma2;
					gl_FragColor = vec4(saturate(m[k]), 1.0);
				}
			}
		}
	</script>

	<!-- MAIN PROGRAM -->

	<script>
		var Kr, Kg, Kb, Kt;
		var video = document.getElementById('video');
		var canvas = document.getElementById('canvas');
		var gl = canvas.getContext('webgl', {preserveDrawingBuffer:true});
		var shader = new webglShader(gl);

		document.addEventListener("DOMContentLoaded", function(event) {
			setupCamera(video, function(err, stream) {
				if (err)
					console.log('VIDEO INITIALIZATION FAILED: ' + err.name);
				else {
					showControls();
					resizeCanvas();
					render();
				}
			});
		});

		function showControls() {
			var controls = document.getElementsByClassName('controls');
			for (var i=0; i < controls.length; i++)
				controls[i].style.display = '';
		}

		function resizeCanvas() {
			if (video.videoWidth/video.videoHeight > screen.width/screen.height) {
				canvas.width = screen.width*.4;
				canvas.height = canvas.width*video.videoHeight/video.videoWidth;
			}
			else {
				canvas.height = screen.height*.4;
				canvas.width = canvas.height*video.videoWidth/video.videoHeight;
			}
		}

		function render() {
			// -- Create shader program --

			var vs = document.getElementById('vshader').textContent;
			var fs = document.getElementById('fshader').textContent;
			var program = shader.createProgram(vs, fs);
			gl.useProgram(program);

			// -- Set shader variables --

			Kr = gl.getUniformLocation(program, 'R');
			Kg = gl.getUniformLocation(program, 'G');
			Kb = gl.getUniformLocation(program, 'B');
			Kt = gl.getUniformLocation(program, 'T');
			var width = gl.getUniformLocation(program, 'width');
			var height = gl.getUniformLocation(program, 'height');
			var sampler = gl.getUniformLocation(program, 'sampler0');
			var position = gl.getAttribLocation(program, 'position');
			gl.uniform1f(Kr, .5);
			gl.uniform1f(Kg, .5);
			gl.uniform1f(Kb, .5);
			gl.uniform1f(Kt, 5);
			gl.uniform1f(width, canvas.width);
			gl.uniform1f(height, canvas.height);
			gl.uniform1i(sampler, 0);
			var vertexPosBuffer = webglScreenQuad(gl);
			gl.enableVertexAttribArray(position);
			gl.vertexAttribPointer(position, vertexPosBuffer.itemSize, gl.FLOAT, false, 0, 0);

			// -- Create texture --

			var texture = gl.createTexture();
			gl.activeTexture(gl.TEXTURE0);
			gl.bindTexture(gl.TEXTURE_2D, texture);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
			gl.bindTexture(gl.TEXTURE_2D, null);

			// -- Render loop --

			gl.viewport(0, 0, canvas.width, canvas.height);
			window.requestAnimationFrame(function loop() {
				gl.activeTexture(gl.TEXTURE0);
				gl.bindTexture(gl.TEXTURE_2D, texture);
				gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, video);
				gl.drawArrays(gl.TRIANGLE_STRIP, 0, vertexPosBuffer.numItems);
				gl.bindTexture(gl.TEXTURE_2D, null);
				window.requestAnimationFrame(loop);
			});
		}

		function snapshot() {
			var dataURL = canvas.toDataURL();
			document.getElementById('snapshot-img').src = dataURL;
		}

		function save() {
			var link = document.getElementById('save-snapshot');
			var now = new Date();
			var stamp = now.getFullYear() + '-' + (now.getMonth() + 1) + '-' + now.getDate() + '-' +
			            now.getHours() + '-' + now.getMinutes() + '-' + now.getSeconds();
			link.download = 'photo_kuwahara_sat_' + stamp + '.png';
	    link.href = document.getElementById('snapshot-img').src;
		}

		var rgb = [
			[0.5, 0.5, 0.5],
			[0.9, 1.1, 1.4],
			[1.2, 1.1, 2.0],
			[1.6, 0.8, 1.6],
			[1.2, 1.1, 1.1]
		];
		var irgb = 0;

		function saturation() {
			irgb = ++irgb % rgb.length;
			gl.uniform1f(Kr, rgb[irgb][0]);
			gl.uniform1f(Kg, rgb[irgb][1]);
			gl.uniform1f(Kb, rgb[irgb][2]);
		}

		// -- Sliders --

		var slider_data = [
			{ label:'R', options:{min:0, max:2, step:.01, value:.5}, slide:function(value) {
				gl.uniform1f(Kr, value);}},
			{ label:'G', options:{min:0, max:2, step:.01, value:.5}, slide:function(value) {
				gl.uniform1f(Kg, value);}},
			{ label:'B', options:{min:0, max:2, step:.01, value:.5}, slide:function(value) {
				gl.uniform1f(Kb, value);}},
			{ label:'T', options:{min:-10, max:10, step:.1, value:5}, slide:function(value) {
				gl.uniform1f(Kt, value);}}
		];
		for (var i = 0; i < slider_data.length; i++)
			JQueryUISlider.CreateSlider('#sliders', slider_data[i]);
		JQueryUISlider.AddSliderStyle();
	</script>
