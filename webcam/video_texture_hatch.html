<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="../css/style.css" />
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<body>
	<div style='display:flex'>
		<div style='justify-content:flex-start'>
			<!-- VIDEO AND CANVAS -->
			<div>
				<video id='video' autoplay='true' style='display:none'></video>
				<canvas id='canvas'></canvas>
			</div>
		</div>
		<div style='justify-content:flex-start'>
			<!-- VIDEO SOURCE CHOOSER -->
			<div class="select" style='margin-left:5px; padding:5px;'>
				<label for="videoSource">Video source: </label>
				<select id="videoSource"></select>
			</div>
			<br>
			<!-- SLIDER CONTROL -->
			<div style='display:inline-block'>
				<div class='controls' style='display:none'>
					<div style='margin-left:5px; padding:5px; font-size:.5em'>
						<div id='sliders' style='border-style:solid; border-width:1px; display:inline-block'/>
					</div>					
					<br>
					<div style='margin-left:5px; padding:5px; font-size:2em'>
						<a id='save-snapshot' onclick='save()' href="#" download='photo_blur.png'>Save snapshot</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div>
		<!-- SNAPSHOT CONTROL -->
		<div class='controls' style='display:none'>
			<div style='margin-top:10px'>
				<img id='snapshot-img' download></img>
			</div>
		</div>
	</div>

	<script src='https://code.jquery.com/jquery-latest.min.js'></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src='js/JQueryUISlider.js'></script>
    <script src='js/webglShader.js'></script>
    <script src='js/webglTexture.js'></script>
	<script src='js/webcam.js'></script>

	<!-- SHADERS -->

	<script id='vshader' type='text/plain'>
		attribute vec2 position;
		void main(void) {
			gl_Position = vec4(position, 0, 1);
		}
	</script>

	<script id='fshader' type='text/plain'>
		precision mediump float;
		uniform sampler2D sampler0;
		uniform float width, height;
		uniform float K1, K2, K3, K4, K5;

		void main() {
			vec2 st = vec2(gl_FragCoord.s/width, 1. - gl_FragCoord.t/height);
			float lum = length(texture2D(sampler0, st).rgb);

			gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);

			if (lum < K1) {
				if (mod(gl_FragCoord.x + gl_FragCoord.y, K5) == 0.0)
					gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
			if (lum < K2) {
				if (mod(gl_FragCoord.x - gl_FragCoord.y, K5) == 0.0)
					gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
			if (lum < K3) {
				if (mod(gl_FragCoord.x + gl_FragCoord.y - K5/2.0, K5) == 0.0)
					gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
			if (lum < K4) {
				if (mod(gl_FragCoord.x - gl_FragCoord.y - K5/2.0, K5) == 0.0)
					gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
		}
	</script>

	<!-- MAIN PROGRAM -->

	<script>
		console.log("VERSION 1.1");
		
		const videoSelect = document.querySelector('select#videoSource');
		const canvas = document.querySelector('#canvas');
		const image = document.querySelector('#image');
		const video = document.querySelector('#video');
		const vs = document.querySelector('#vshader').textContent;
		const fs = document.querySelector('#fshader').textContent;
	
		// Setup shader program and variables 
		const gl = canvas.getContext('webgl', { preserveDrawingBuffer:true });
		const program = createProgram(gl, vs, fs);
		const k1 = gl.getUniformLocation(program, 'K1');
		const k2 = gl.getUniformLocation(program, 'K2');
		const k3 = gl.getUniformLocation(program, 'K3');
		const k4 = gl.getUniformLocation(program, 'K4');
		const k5 = gl.getUniformLocation(program, 'K5');
		const width = gl.getUniformLocation(program, 'width');
		const height = gl.getUniformLocation(program, 'height');
		const sampler = gl.getUniformLocation(program, 'sampler0');
		const position = gl.getAttribLocation(program, 'position');
		const texture = createTexture(gl);
		const vertexBuffer = webglScreenQuad(gl);
		gl.uniform1i(sampler, 0);
		gl.enableVertexAttribArray(position);
		gl.vertexAttribPointer(position, vertexBuffer.itemSize, gl.FLOAT, false, 0, 0);

		let videoScale = 0.5;
		let animID = undefined;

		document.addEventListener('DOMContentLoaded', function(event) {
			videoSelect.onchange = () => {
				setupCamera(video, videoSelect.value, (err, stream) => {
					if (err)
						alert('WEBCAM INITIALIZATION FAILED: ' + JSON.stringify(err));
					else {
						showControls();
						resizeCanvas(videoScale);
						render();
					}
				});
			};

			discoverCameras((err, {label, id}) => {
				const option = document.createElement('option');
				option.value = id;
				option.text = label;
				videoSelect.appendChild(option);
				if (videoSelect.length === 1) 
					videoSelect.dispatchEvent(new Event('change'));
			});
		});

		function showControls() {
			var controls = document.getElementsByClassName('controls');
			for (var i=0; i < controls.length; i++)
				controls[i].style.display = '';
		}

		function resizeCanvas(scale) {
			videoScale = scale;
			if (video.videoWidth/video.videoHeight > screen.width/screen.height) {
				canvas.width = screen.width * videoScale;
				canvas.height = canvas.width*video.videoHeight/video.videoWidth;
			}
			else {
				canvas.height = screen.height * videoScale;
				canvas.width = canvas.height*video.videoWidth/video.videoHeight;
			}
		}

		function render() {
			gl.uniform1f(k1, 1.);
			gl.uniform1f(k2, .75);
			gl.uniform1f(k3, .5);
			gl.uniform1f(k4, .25);
			gl.uniform1f(k5, 10.0);
			gl.uniform1f(width, canvas.width);
			gl.uniform1f(height, canvas.height);
			gl.viewport(0, 0, canvas.width, canvas.height);

			window.cancelAnimationFrame(animID);
			animID = window.requestAnimationFrame(function loop() {
				updateTexture(gl, texture, vertexBuffer, video);
				animID = window.requestAnimationFrame(loop);
			});
		}

		function save() {
			var dataURL = canvas.toDataURL();
			document.getElementById('snapshot-img').src = dataURL;
			var link = document.getElementById('save-snapshot');
			var now = new Date();
			var stamp = now.getFullYear() + '-' + (now.getMonth() + 1) + '-' + now.getDate() + '-' +
			            now.getHours() + '-' + now.getMinutes() + '-' + now.getSeconds();
			link.download = 'photo_hash_' + stamp + '.png';
	    		link.href = document.getElementById('snapshot-img').src;
		}

		// -- Sliders --

		var slider_data = [
			{ label:'SIZE', options:{min:0.2, max:.8, step:.1, value:.8}, slide:function(value) {
				resizeCanvas(value); render();}},
			{ label:'SLANT LEFT 1', options:{min:0., max:1., step:.01, value:1.}, slide:function(value) {
				gl.uniform1f(k1, value);}},
			{ label:'SLANT RIGHT 1', options:{min:0., max:1., step:.01, value:.75}, slide:function(value) {
				gl.uniform1f(k2, value);}},
			{ label:'SLANT LEFT 2', options:{min:0., max:1., step:.01, value:.5}, slide:function(value) {
				gl.uniform1f(k3, value);}},
			{ label:'SLANT RIGHT 2', options:{min:0., max:1., step:.01, value:.25}, slide:function(value) {
				gl.uniform1f(k4, value);}},
			{ label:'SEPARATION', options:{min:2., max:24., step:1., value:10.}, slide:function(value) {
				gl.uniform1f(k5, value);}}
		];
		for (var i = 0; i < slider_data.length; i++)
			JQueryUISlider.CreateSlider('#sliders', slider_data[i]);
		JQueryUISlider.AddSliderStyle();
	</script>
