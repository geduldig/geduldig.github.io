<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<link rel="stylesheet" href="style/style.css">

<body>
	<main role='main' class='container-fluid test'>
		<div class='row'>
			<div>
				<!-- VIDEO -->
				<div>
					<video id='video' autoplay='true' style='display:none'></video>
					<canvas id='canvas' onclick=toggleMenu()></canvas>
				</div>
			</div>
			<div id='menu' class='col-lg-6' style='display:none'>
				<div>
					<span id='closeMenu' style='display:inline-block'>
						<button onclick=hideMenu()></button>
					</span>
				</div>
				<!-- VIDEO SOURCE CHOOSER -->
				<div class='d-flex flex-row bd-highlight mb-3'>
					<label class='left-label p-2 bd-highlight' for='videoSource'>Video</label>
					<select class='p-2 bd-highlight' id='videoSource' class='form-control'></select>
					<button id='facingMode' class='p-2 bd-highlight btn btn-primary' onclick=toggleFacingMode()><img src='style/flipCamera.png' width='30' /></button>
				</div>
				<!-- SLIDER CONTROLS -->
				<div class='controls range-field'>
					<form id='sliders' />
				</div>
				<!-- PRESET AND SNAPSHOT BUTTONS -->
				<div style='display:inline-block'>
					<div class='d-flex flex-row bd-highlight mb-3'>
						<label id='presets-label' class='left-label p-2 bd-highlight' for='presets'>Presets</label>
						<span id='presets' style='display:inline-block'></span>
						<span id='snapshot' class='ml-auto'>
							<div style='display:inline-block'>
								<button id='save-snapshot' class='btn btn-outline-primary' type='button' onclick='saveSnapshot()'>Save snapshot</button>
								<a id='snapshot-link' href='#'></a>
								<img id='snapshot-img' style='display:none'></img>
							</div>
						</span>
					</div>					
				</div>
			</div>
		</div>
	</main>

	<!-- SHADERS -->

	<script id='vshader' type='text/plain'>
		attribute vec2 position;
		void main(void) {
			gl_Position = vec4(position, 0, 1);
		}
	</script>

	<script id='fshader' type='text/plain'>
		precision mediump float;
		uniform sampler2D sampler0;
		uniform float width, height;
		uniform float K1, K2, K3, K4, K5;

		void main() {
			vec2 st = vec2(gl_FragCoord.s/width, 1. - gl_FragCoord.t/height);
			vec3 c = texture2D(sampler0, st).rgb;
			float lum = 0.21 * c.r + 0.72 * c.g + 0.07 * c.b;
			gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);

			if (lum < K1) {
				if (mod(gl_FragCoord.x + gl_FragCoord.y, K5) == 0.0)
					gl_FragColor.a = 1.0;
			}
			if (lum < K2) {
				if (mod(gl_FragCoord.x - gl_FragCoord.y, K5) == 0.0)
				gl_FragColor.a = 1.0;
			}
			if (lum < K3) {
				if (mod(gl_FragCoord.x + gl_FragCoord.y - K5/2.0, K5) == 0.0)
				gl_FragColor.a = 1.0;
			}
			if (lum < K4) {
				if (mod(gl_FragCoord.x - gl_FragCoord.y - K5/2.0, K5) == 0.0)
				gl_FragColor.a = 1.0;
			}
		}
	</script>

	<!-- MAIN PROGRAM -->

	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src='js/webglShader.js'></script>
    <script src='js/webglTexture.js'></script>
	<script src='js/webcam.js'></script>
	<script src='js/common.js'></script>

	<script>
		console.log("VERSION 1.2");

		// -- Shader control knobs --
		
		const k1 = gl.getUniformLocation(program, 'K1');
		const k2 = gl.getUniformLocation(program, 'K2');
		const k3 = gl.getUniformLocation(program, 'K3');
		const k4 = gl.getUniformLocation(program, 'K4');
		const k5 = gl.getUniformLocation(program, 'K5');

		// -- Sliders --

		if (!isMobileDevice) {
			const scaleUpdate = CreateSlider('slider0', 'Video scale', 0.2, 1.0, 0.01, () => {
				resizeCanvas(document.querySelector('#slider0 > input').value);
			});
			scaleUpdate(1);
		}

		const slider1Update = CreateSlider('slider1', 'Hatch1 left', 0, 1, 0.01, () => {
			gl.uniform1f(k1, document.querySelector('#slider1 > input').value);
		});

		const slider2Update = CreateSlider('slider2', 'Hatch1 right', 0, 1, 0.01, () => {
			gl.uniform1f(k2, document.querySelector('#slider2 > input').value);
		});

		const slider3Update = CreateSlider('slider3', 'Hatch2 left', 0, 1, 0.01, () => {
			gl.uniform1f(k3, document.querySelector('#slider3 > input').value);
		});

		const slider4Update = CreateSlider('slider4', 'Hatch2 right', 0, 41, 0.01, () => {
			gl.uniform1f(k4, document.querySelector('#slider4 > input').value);
		});

		const slider5Update = CreateSlider('slider5', 'Separation', 1, 20, 1, () => {
			const  val = checkSeparation(document.querySelector('#slider5 > input').value);
			gl.uniform1f(k5, val);
		});

		function checkSeparation(val) {
			console.log(val)
			const badValues = [ 7, 13, 14, 15];
			if (badValues.includes(val)) 
				return checkSeparation(val + 1);
			else
				return val;
		}

		// -- Presets --

		createPreset('1', () => {
			slider1Update(.25);
			slider2Update(.25);
			slider3Update(.25);
			slider4Update(.25);
			slider5Update(6);
		}).onclick();

		createPreset('2', () => {
			slider1Update(.2);
			slider2Update(.2);
			slider3Update(.2);
			slider4Update(.2);
			slider5Update(4);
		});

		createPreset('3', () => {
			slider1Update(.5);
			slider2Update(.2);
			slider3Update(.2);
			slider4Update(.2);
			slider5Update(16);
		});	
	</script>
</body>