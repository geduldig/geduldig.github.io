<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="css/style.css">

<body>
	<div class='container' id='main'>
		<video id='video' autoplay='true' style='display:none'></video>
		<span>
			<canvas id='c'></canvas>
			<button id='snapshot-btn' onclick='snapshot()'>Snapshot2</button>
		</span>
	</div>
	<div id='controls' style='display:none'>
		<span style='float:right'>
			<button id='snapshot-btn' onclick='snapshot()'>Snapshot</button>
		</span>
		<div id='snapshot-section'>
			<img id='snapshot-img'></img>
		</div>
	</div>

	<script src='js/webgl-utils.js'></script>
	<script src='js/video-utils.js'></script>
	
	<script id='vshader' type='text/plain'>
		attribute vec2 position;
		void main(void) {
			gl_Position = vec4(position, 0, 1);
		}
	</script>

	<script id='fshader' type='text/plain'>
		#ifdef GL_ES
		precision highp float;
		#endif
		uniform sampler2D sampler0;
		uniform float width;
		uniform float height;
		vec3 posterize(vec3 rgb) {
			float gamma = .6;
			float ncolors = 8.;
			rgb = pow(rgb, vec3(gamma, gamma, gamma));
			rgb = rgb * ncolors;
			rgb = floor(rgb);
			rgb = rgb / ncolors;
			return pow(rgb, vec3(1./gamma));
		}
		void main(void) {
			const mat3 Gx = mat3(-1, 0, 1, -2, 0, 2, -1, 0, 1);
			const mat3 Gy = mat3(-1, -2, -1, 0, 0, 0, 1, 2, 1);
			vec2 dim = vec2(width, height);
			vec2 p = vec2(gl_FragCoord.x, height - gl_FragCoord.y);
			vec2 x0y0 = (p + vec2(-1, -1)) / dim;
			vec2 x0y1 = (p + vec2(-1,  0)) / dim;
			vec2 x0y2 = (p + vec2(-1,  1)) / dim;
			vec2 x1y0 = (p + vec2(0, -1)) / dim;
			vec2 x1y1 = (p + vec2(0,  0)) / dim;
			vec2 x1y2 = (p + vec2(0,  1)) / dim;
			vec2 x2y0 = (p + vec2(1, -1)) / dim;
			vec2 x2y1 = (p + vec2(1,  0)) / dim;
			vec2 x2y2 = (p + vec2(1,  1)) / dim;
		
			vec4 tx0y0 = texture2D(sampler0, x0y0);
			vec4 tx0y1 = texture2D(sampler0, x0y1);
			vec4 tx0y2 = texture2D(sampler0, x0y2);
			vec4 tx1y0 = texture2D(sampler0, x1y0);
			vec4 tx1y1 = texture2D(sampler0, x1y1);
			vec4 tx1y2 = texture2D(sampler0, x1y2);
			vec4 tx2y0 = texture2D(sampler0, x2y0);
			vec4 tx2y1 = texture2D(sampler0, x2y1);
			vec4 tx2y2 = texture2D(sampler0, x2y2);

			mat3 id = Gx;
			vec4 colorGx = 
				id[0][0] * tx0y0 + id[0][1] * tx1y0 + id[0][2] * tx2y0 +
				id[1][0] * tx0y1 + id[1][1] * tx1y1 + id[1][2] * tx2y1 +
				id[2][0] * tx0y2 + id[2][1] * tx1y2 + id[2][2] * tx2y2;
			id = Gy;
			vec4 colorGy = 
				id[0][0] * tx0y0 + id[0][1] * tx1y0 + id[0][2] * tx2y0 +
				id[1][0] * tx0y1 + id[1][1] * tx1y1 + id[1][2] * tx2y1 +
				id[2][0] * tx0y2 + id[2][1] * tx1y2 + id[2][2] * tx2y2;

			float fColorGx = colorGx.r;
			float fColorGy = colorGy.r;
			float norm = fColorGx * fColorGx + fColorGy * fColorGy;
			norm = clamp(1. - 2.*sqrt(norm), 0., 1.);
			vec4 edges = vec4(norm, norm, norm, 1.);
			vec2 st = vec2(gl_FragCoord.s/width, 1. - gl_FragCoord.t/height);
			vec3 rgb = texture2D(sampler0, st).rgb;
			rgb = posterize(rgb);
			rgb = clamp(rgb+.25, 0., 1.);
			gl_FragColor = vec4(rgb, 1.) * edges;
		}
	</script>
	
	<script>
		var videoScale = .75;
		var video, c, gl, shader;

		document.addEventListener("DOMContentLoaded", function(event) {
			video = document.getElementById('video');
			c = document.getElementById('c');
			gl = c.getContext('experimental-webgl') || c.getContext('webgl');
			shader = new webglShader(gl);
			
			setupCamera(video, function(err, stream) { 
				if (err)
					console.log('VIDEO INITIALIZATION FAILED: ' + err.name);
				else {
					video.style.display = '';
					document.getElementById('controls').style.display = '';
					video.width = video.videoWidth *= videoScale;
					video.height = video.videoHeight *= videoScale;
					c.width = video.width;
					c.height = video.height;
					render();
				}
			});
		});

		function render() {
			// CREATE SHADER PROGRAM
			var vs = document.getElementById('vshader').textContent;
			var fs = document.getElementById('fshader').textContent;
			var program = shader.createProgram(vs, fs);
			gl.useProgram(program);

			// SET SHADER VARIABLES
			var widthLocation = gl.getUniformLocation(program, 'width');
			var heightLocation = gl.getUniformLocation(program, 'height');
			var samplerLocation = gl.getUniformLocation(program, 'sampler0');
			var positionLocation = gl.getAttribLocation(program, 'position');
			gl.uniform1f(widthLocation, c.width);
			gl.uniform1f(heightLocation, c.height);
			gl.uniform1i(samplerLocation, 0);
			var vertexPosBuffer = webglScreenQuad(gl);
			gl.enableVertexAttribArray(positionLocation);
			gl.vertexAttribPointer(positionLocation, vertexPosBuffer.itemSize, gl.FLOAT, false, 0, 0);
		
			// CREATE TEXTURE
			var texture = gl.createTexture();
			gl.activeTexture(gl.TEXTURE0);
			gl.bindTexture(gl.TEXTURE_2D, texture);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
			gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
			gl.bindTexture(gl.TEXTURE_2D, null);

			// RENDER LOOP
			gl.viewport(0, 0, c.width, c.height);
			window.requestAnimationFrame(function loop() {
				gl.activeTexture(gl.TEXTURE0);
				gl.bindTexture(gl.TEXTURE_2D, texture);
				gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, video);
				gl.drawArrays(gl.TRIANGLE_STRIP, 0, vertexPosBuffer.numItems);
				gl.bindTexture(gl.TEXTURE_2D, null);
				window.requestAnimationFrame(loop);
			});
		}
		
		function snapshot() {
			var dataURL = c.toDataURL();
			document.getElementById('snapshot-img').src = dataURL;
		}
	</script>
